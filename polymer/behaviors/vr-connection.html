<!--
Attention: Use this behavior when you're creating a connecting. This behavior
does a lot. The new connection need the functions:
* "_render(points)"
* "_preResize()"

The task of "_render" is to draw the connection.
The task of "preResize" is to prepare to draw a new line but you don't need to
call "_render" by yourself.

If you're confused see vr-connection-inheritance as an example for the usage
of this behavior.
-->

<script>
    window.VrBehaviors = window.VrBehaviors || {};
    VrBehaviors.ConnectionBehavior = {

        properties: {
            from: String,
            to: String
        },

        attached: function() {
            if (!this.from || !this.to) {
                console.error('properties from and to must be set');
                return;
            }

            var cb = this.ConnectionBehavior = {
                fromObj: document.querySelector(this.from),
                toObj: document.querySelector(this.to),
                resize: this._updateConnection.bind(this),
                delete: this._deleteConnection.bind(this)
            };

            if (!cb.fromObj || !cb.toObj) {
                console.error('could not find element');
                return;
            }

            // calculate and render connection
            this._render();

            // add event listener for resizing
            this._handleListener(cb.fromObj.addEventListener.bind(cb.fromObj));
            this._handleListener(cb.toObj.addEventListener.bind(cb.toObj));

            // add Polymer children to three js group
            Polymer.dom(this.root).children.forEach(function (node) {
                if(node.nodeName != "VR-PLACING") this.obj.add(node.obj);
            }.bind(this));
        },

        _handleListener: function(func) {
            func('vr-resize', this.ConnectionBehavior.resize);
            func('vr-delete', this.ConnectionBehavior.delete);
        },

        _updateConnection: function () {
            this._removeOldConnection();
            this._render();
        },

        _removeOldConnection: function() {
            removeAllChildren(this.$.line);
            removeAllGroups(this.obj.children);

            function removeAllGroups(children) {
                children.forEach(function(child) {
                    if(child instanceof THREE.Group) {
                        removeAllGroups(child.children)
                        child.parent.remove(child);
                    }
                });
            }

            function removeAllChildren(parent) {
                var dom = Polymer.dom(parent);
                dom.children.forEach(function (child) {
                    dom.removeChild(child);
                });
            }
        },

        _render: function() {
            var cb = this.ConnectionBehavior;
            var gc = new GeneralConnection(cb.fromObj, cb.toObj);
            var connection = gc.render(this._getPlacings());

            // set startpoint
            this.obj.position.setX(connection.coord.x);
            this.obj.position.setY(connection.coord.y);

            // set angle
            this.obj.rotation.z = connection.angle || 0;

            // points to polyline
            connection.lines.forEach(function(point) {
                this._createLinePoint(point.x, point.y);
            }.bind(this));

            // add placings
            connection.placingObjs.forEach(function(placingObj) {
                this.obj.add(placingObj);
            }.bind(this));
        },

        _getPlacings: function() {
            return Polymer.dom(this.root).children.filter(function(node) {
                return node.nodeName == "VR-PLACING";
            })
        },

        _deleteConnection: function() {
            var cb = this.ConnectionBehavior;
            this._handleListener(cb.fromObj.removeEventListener.bind(cb.fromObj));
            this._handleListener(cb.toObj.removeEventListener.bind(cb.toObj));

            Polymer.dom(this.parentNode).removeChild(this);
        },

        _createLinePoint: function(x, y) {
            this._createPoint(x, y, this.$.line);
        },

        _createPoint: function(x, y, element) {
            var point = document.createElement('vr-point');
            point.x = x;
            point.y = y;
            Polymer.dom(element).appendChild(point);
        }
    };
</script>
