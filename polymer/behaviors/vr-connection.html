<!--
Attention: Use this behavior when you're creating a connecting. This behavior
does a lot. The new connection need the functions:
* "_render(points)"
* "_preResize()"

The task of "_render" is to draw the connection.
The task of "preResize" is to prepare to draw a new line but you don't need to
call "_render" by yourself.

If you're confused see vr-connection-inheritance as an example for the usage
of this behavior.
-->

<script>
    window.VrBehaviors = window.VrBehaviors || {};
    VrBehaviors.ConnectionBehavior = {

        properties: {
            from: String,
            to: String
        },

        attached: function() {
            if (!this.from || !this.to) {
                console.error('properties from and to must be set');
                return;
            }

            var cb = this.ConnectionBehavior = {
                fromObj: document.querySelector(this.from),
                toObj: document.querySelector(this.to),
                resize: this._resizeConnection.bind(this),
                delete: this._deleteConnection.bind(this)
            };

            if (!cb.fromObj || !cb.toObj) {
                console.error('could not find element');
                return;
            }

            // calculate and render connection
            this._preRender();

            // add event listener for resizing
            this._handleListener(cb.fromObj.addEventListener.bind(cb.fromObj));
            this._handleListener(cb.toObj.addEventListener.bind(cb.toObj));

            // add Polymer children to three js group
            Polymer.dom(this.root).children.forEach(function (node) {
                if(node.nodeName != "VR-PLACING") this.obj.add(node.obj);
            }.bind(this));
        },

        _handleListener: function(func) {
            func('vr-resize', this.ConnectionBehavior.resize);
            func('vr-delete', this.ConnectionBehavior.delete);
        },

        _resizeConnection: function () {
            this._preResize();
            this._preRender();
        },

        _preRender: function() {
            var cb = this.ConnectionBehavior;
            this._render((new GeneralConnection(cb.fromObj, cb.toObj).render()));
        },

        _deleteConnection: function() {
            var cb = this.ConnectionBehavior;
            this._handleListener(cb.fromObj.removeEventListener.bind(cb.fromObj));
            this._handleListener(cb.toObj.removeEventListener.bind(cb.toObj));

            Polymer.dom(this.parentNode).removeChild(this);
        }
    };
</script>
