<link rel="import" href="vr-three.html">
<link rel="import" href="../elements/vr-placing.html">

<!--
This behavior contains the complete logic for all kinds of connections.
You propably don't need to change anything in this file. If you want to change
the line e.g that it has edges instead of just a diagonal line you need to
change the implementation of GeneralConnection.
-->

<script>
    window.VrBehavior = window.VrBehavior || {};
    VrBehavior.Connection = [VrBehavior.ThreeJS, {

        properties: {
            from: String,
            to: String
        },

        attached: function() {
            if (!this.from || !this.to) {
                console.error('properties from and to must be set');
                return;
            }

            var cb = this.ConnectionBehavior = {
                fromObj: document.querySelector(this.from),
                toObj: document.querySelector(this.to),
                resize: this._updateConnection.bind(this),
                delete: this._deleteConnection.bind(this),
                mousedown: this._handleClick.bind(this)
            };

            if (!cb.fromObj || !cb.toObj) {
                console.error('could not find element');
                return;
            }
            this.highlighted = false;

            // calculate and render connection
            this._render();

            // add event listener for resizing
            this._handleListener(cb.fromObj.addEventListener.bind(cb.fromObj));
            this._handleListener(cb.toObj.addEventListener.bind(cb.toObj));
            this.getThreeJS().on('mousedown', cb.mousedown);

            // add Polymer children to three js group
            Polymer.dom(this.root).children.forEach(function (node) {
                if(!(node instanceof VrElement.Placing)) {
                    this.getThreeJS().add(node.getThreeJS());
                }
            }.bind(this));
        },

        _handleListener: function(func) {
            func('vr-resize', this.ConnectionBehavior.resize);
            func('vr-delete', this.ConnectionBehavior.delete);
        },

        _updateConnection: function () {
            this._removeOldConnection();
            this._render();
        },

        _removeOldConnection: function() {
            removeAllChildren(this.$.line);
            removeAllGroups(this.getThreeJS().children);

            function removeAllGroups(children) {
                children.forEach(function(child) {
                    if(child instanceof THREE.Group) {
                        removeAllGroups(child.children);
                        child.parent.remove(child);
                    }
                });
            }

            function removeAllChildren(parent) {
                var dom = Polymer.dom(parent);
                dom.children.forEach(function (child) {
                    dom.removeChild(child);
                });
            }
        },

        _render: function() {
            var cb = this.ConnectionBehavior;
            var gc = new GeneralConnection(cb.fromObj, cb.toObj);
            var connection = gc.render(this._getPlacings());

            // set startpoint
            this.getThreeJS().position.setX(connection.coord.x);
            this.getThreeJS().position.setY(connection.coord.y);

            // set angle
            this.getThreeJS().rotation.z = connection.angle || 0;

            // points to polyline
            connection.lines.forEach(function(point) {
                this._createLinePoint(point.x, point.y);
            }.bind(this));

            // set value of width for delete button
            this.width = connection.lines[connection.lines.length-1].y;

            // add placings
            connection.placingObjs.forEach(function(placingObj) {
                this.getThreeJS().add(placingObj);
            }.bind(this));
        },

        _getPlacings: function() {
            return Polymer.dom(this.root).children.filter(function(node) {
                return (node instanceof VrElement.Placing);
            })
        },

        _deleteConnection: function() {
            var cb = this.ConnectionBehavior;
            this._handleListener(cb.fromObj.removeEventListener.bind(cb.fromObj));
            this._handleListener(cb.toObj.removeEventListener.bind(cb.toObj));
            this.getThreeJS().off('mousedown', cb.mousedown);

            if(this.parentNode === null) return; // TODO: quick fix
            Polymer.dom(this.parentNode).removeChild(this);
        },

        _createLinePoint: function(x, y) {
            this._createPoint(x, y, this.$.line);
        },

        _createPoint: function(x, y, element) {
            var point = document.createElement('vr-point');
            point.x = x;
            point.y = y;
            Polymer.dom(element).appendChild(point);
        },

        _handleClick: function(event) {
            this.highlighted = !this.highlighted;

            // change color of line
            this.$.line.line.material.color.set(this.highlighted? 0xFF0000 : 0x000000);
        }
    }];
</script>
