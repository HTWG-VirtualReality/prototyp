<!--
Attention: Use this behavior when you're creating a connecting. This behavior
does a lot. The new connection must have the functions:
* "_render(points)"
* "_preResize()"

The task of "_render" is to draw the connection.
The task of "preResize" is to prepare to draw a new line but you don't need to
call "_render" by yourself.

If you're confused see vr-connection-inheritance as an example for the usage
of this behavior.
-->

<script>
    window.VrBehaviors = window.VrBehaviors || {};
    VrBehaviors.ConnectionBehavior = {

        properties: {
            from: String,
            to: String
        },

        ready: function() {
            if (!this.from || !this.to) {
                console.error('properties from and to must be set');
                return;
            }

            this.ConnectionBehavior = {
                fromObj: document.querySelector(this.from),
                toObj: document.querySelector(this.to),
                resize: this._resizeConnection.bind(this),
                delete: this._deleteConnection.bind(this)
            };

            if (!this.ConnectionBehavior.fromObj || !this.ConnectionBehavior.toObj) {
                console.error('could not find element');
                return;
            }

            // calculate and render connection
            this._preRender();

            // add event listener for resizing
            this._registerListener()

            // add Polymer children to three js group
            Polymer.dom(this.root).children.forEach(function (box) {
                this.obj.add(box.obj);
            }.bind(this));
        },

        _registerListener: function() {
            var cb = this.ConnectionBehavior;
            cb.fromObj.addEventListener('vr-resize', cb.resize);
            cb.fromObj.addEventListener('vr-delete', cb.delete);
            cb.toObj.addEventListener('vr-resize', cb.resize);
            cb.toObj.addEventListener('vr-delete', cb.delete);
        },

        _deregisterListener: function() {
            var cb = this.ConnectionBehavior;
            cb.fromObj.removeEventListener('vr-resize', cb.resize);
            cb.fromObj.removeEventListener('vr-delete', cb.delete);
            cb.toObj.removeEventListener('vr-resize', cb.resize);
            cb.toObj.removeEventListener('vr-delete', cb.delete);
        },

        _resizeConnection: function () {
            console.log('resize..')
            this._preResize();
            this._preRender();
        },

        _preRender: function() {
            var fromObj = this.ConnectionBehavior.fromObj;
            var toObj = this.ConnectionBehavior.toObj;
            this._render((new GeneralConnection(fromObj, toObj).render()))
        },

        _deleteConnection: function() {
            this._deregisterListener();

            Polymer.dom(this.parentNode).removeChild(this);
        }
    };
</script>
