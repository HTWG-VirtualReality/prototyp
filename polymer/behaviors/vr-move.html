<link rel="import" href="vr-three.html">

<script>
    window.VrBehavior = window.VrBehavior || {};
    VrBehavior.Move = [VrBehavior.ThreeJS, {

        properties: {
            xPos: {
                type: Number,
                value: 0,
                observer: '_changeXPosition'
            },
            yPos: {
                type: Number,
                value: 0,
                observer: '_changeYPosition'
            }
        },

        ready: function () {
            this.getThreeJS().on('mousedown', this.onMouseDown.bind(this));
            this.getThreeJS().position.setX(this.xPos);
            this.getThreeJS().position.setY(this.yPos);
        },

        onMouseDown: function (event) {
            event.origDomEvent.stopImmediatePropagation();
            var self = this;
            var dom = event.origDomEvent.target;
            var position = {
                x: event.origDomEvent.clientX,
                y: event.origDomEvent.clientY
            };

            // handling move in vr via touch
            this.handleTouchMove(dom);

            // handling move not in vr via mouse
            dom.addEventListener('mousemove', onMouseMove);
            dom.addEventListener('mouseup', reset);
            dom.addEventListener('mouseout', reset);

            function onMouseMove(e) {
                // calculate new position of element
                self.xPos += e.clientX - position.x;
                self.yPos -= e.clientY - position.y;

                // update position
                position.x = e.clientX;
                position.y = e.clientY;
            }

            function reset() {
                dom.removeEventListener('mousemove', onMouseMove);
                dom.removeEventListener('mouseup', reset);
                dom.removeEventListener('mouseout', reset);
            }
        },

        handleTouchMove: function (dom) {
            var self = this;
            var camera = VrBehavior.Scene.camera;
            var startDirection = camera.getWorldDirection();

            dom.addEventListener('touchend', touchEnd);

            function touchEnd() {
                var endDirection = camera.getWorldDirection();
                var movement = {
                    x: endDirection.x - startDirection.x,
                    y: endDirection.y - startDirection.y
                };

                // TODO: improve calculation, may could not work on other zoom level
                movement.x *= 400;
                movement.y *= 400;

                // update position
                self.xPos += movement.x;
                self.yPos += movement.y;

                dom.removeEventListener('touchend', touchEnd);
            }
        },

        _changeXPosition: function(value) {
            if (this.getThreeJS()) {
                this.getThreeJS().position.setX(value);
            }
        },

        _changeYPosition: function(value) {
            if (this.getThreeJS()) {
                this.getThreeJS().position.setY(value);
            }
        }
    }];
</script>