<link rel="import" href="vr-three.html">
<link rel="import" href="../elements/vr-box.html">

<script>
    window.VrBehavior = window.VrBehavior || {};
    VrBehavior.Highlight = [VrBehavior.ThreeJS, {

        properties: {
            _highlight_elements: {
                type: Array,
                value: function() {
                    return [];
                },
                readOnly: true
            },

            highlight: {
                type: Boolean,
                value: false
            },

            highlighted: {
                type: Boolean,
                value: false
            },

            highlight_color: {
                type: String,
                value: "ff0000",
                readOnly: true
            }
        },

        ready: function() {
            var self = this;
            var originalColor = {};

            var COLOR_NORMAL = 0x000000;
            var COLOR_HIGHLIGHTED = 0xff0000;

            this.getThreeJS().on('mousedown', function() {
                if (!self.highlight) {
                    return;
                }

                self.highlighted = !self.highlighted;
                var boxes = Polymer.dom(this.root).children.filter(function(node) {
                    return (node instanceof VrElement.Box);
                });
                iterateBoxes(boxes);

                self._highlight_elements.forEach(function(material) {
                    var color = getColor(material);
                    material.color.set(parseInt("0x" + color));
                })
            }.bind(self));

            function iterateBoxes(boxes) {
                boxes.forEach(function (node){
                    node.getThreeJS().children.forEach(function(element) {
                        toggleHighlighting(element);
                    });
                });
            }
            function toggleHighlighting(element) {
                if (element instanceof THREE.LineSegments) {
                    element.material.color.set(self.highlighted ? COLOR_HIGHLIGHTED : COLOR_NORMAL);
                }
            }
            function getColor(material) {
                if (self.highlighted) {
                    originalColor[material.uuid] = material.color.getHexString();
                    return self.highlight_color;
                }
                return originalColor[material.uuid]
            }
        },

        addHighlight: function(material) {
            if (!(material instanceof THREE.Material)) {
                throw new Error('material must be instance of `THREE.Material`');
            }
            if (!material.color) {
                throw new Error('material must have color attribute');
            }
            this._highlight_elements.push(material);
        }
    }];
</script>