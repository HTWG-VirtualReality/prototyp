<link rel="import" href="vr-three.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<script>
    window.VrBehavior = window.VrBehavior || {};
    VrBehavior.LoadElements = [VrBehavior.ThreeJS, {
        connectionMap: {
            association: function () {
                return new VrElement.ConnectionAssociation();
            },
            baseclassrealization: function () {
                return new VrElement.ConnectionInheritance();
            },
            aggregation: function () {
                return new VrElement.ConnectionAggregation();
            }
        },
        classMap: {
            interfaceklasse: function () {
                return new VrElement.Interface();
            },
            interface: function () {
                return new VrElement.Interface();
            },
            abstractklasse: function () {
                return new VrElement.AbstractKlasse();
            },
            klasse: function () {
                return new VrElement.Klasse();
            }
        },

        attached: function () {
            var self = this;
            var token = null;

            getToken();

            function getToken() {
                var accessTokenAttributes = {
                    method: 'POST',
                    url: 'http://localhost:9000/oauth/accessTokenLocal',
                    contentType: 'application/x-www-form-urlencoded',
                    body: 'client_id=modigen-browser-app1&grant_type=implicit',
                    id: 'token',
                    withCredentials: true,
                    success: _onTokenSuccess,
                    failure: _onFailure
                };

                self._createRequest(accessTokenAttributes);
            }

            function _onTokenSuccess(event) {
                token = event.detail.xhr.response.token_type + ' ' + event.detail.xhr.response.access_token;

                // get model id from href
                var href = window.location.href;
                var modelId = href.substr(href.lastIndexOf('/') + 1, href.length);

                _getModel(modelId);
            }

            function _getModel(modelId) {
                var modelAttributes = {
                    id: 'model',
                    method: 'GET',
                    url: 'http://localhost:9000/models/' + modelId,
                    withCredentials: true,
                    headers: {'authorization': token},
                    success: _onModelSuccess,
                    failure: _onFailure
                };

                self._createRequest(modelAttributes);
            }

            function _onModelSuccess(event) {
                // get ui-state
                var model = JSON.parse(event.detail.xhr.response.model.uiState);

                var connections = [];
                model.cells.forEach(function (element) {
                    if (typeof element.mClass !== 'undefined') {
                        self.pushNewElement(element.id, element.mClass.toLowerCase(), element.position, element.size);
                    } else {
                        connections.push(element);
                    }
                });

                // create connections after classes
                connections.forEach(function (element) {
                    self.pushNewConnection(element.subtype.toLowerCase(), {
                        from: element.source.id,
                        to: element.target.id,
                        id: element.id
                    });
                });
            }

            function _onFailure(error) {
                console.error(error);
            }
        },

        _createRequest: function (attributes) {
            var element = document.createElement("iron-ajax");

            element.setAttribute('id', attributes.id);
            element.setAttribute('method', attributes.method);
            element.setAttribute('url', attributes.url);
            element.setAttribute('with-credentials', attributes.withCredentials);

            if ('body' in attributes) {
                element.setAttribute('body', attributes.body);
            }

            if ('params' in attributes) {
                element.setAttribute('params', attributes.params)
            }

            if ('contentType' in attributes) {
                element.setAttribute('content-type', attributes.contentType);
            }

            if ('headers' in attributes) {
                element.headers = attributes.headers;
            }
            element.addEventListener('iron-ajax-response', attributes.success);
            element.addEventListener('iron-ajax-error', attributes.failure);

            element.generateRequest();
        },

        pushNewElement: function (elementId, text, position, size) {
            var self = this;

            switch (text) {
                case "transition":
                    this.push('transitionItems', {
                        id: elementId,
                        xPos: position.x,
                        yPos: position.y * -1,
                        classType: text.toLowerCase()
                    });
                    break;

                case "place":
                    this.push('placeItems', {
                        id: elementId,
                        xPos: position.x,
                        yPos: position.y * -1,
                        classType: text.toLowerCase()
                    });
                    break;
                default:
                    if (text.toLowerCase() in this.classMap) {
                        var element = this.classMap[text.toLowerCase()]();
                        element.id = elementId;
                        element.xPos = position != null ? position.x : 0;
                        element.yPos = position != null ? position.y * -1 : 0;
                        element.width = size != null ? size.width : 100;
                        element.height = size != null ? size.height : 100;
                        Polymer.dom(self.root).appendChild(element);
                    } else {
                        console.error("No valid element found! Caution generated Code.");
                    }
            }
        },
        pushNewConnection: function (type, connection) {
            var self = this;
            if (type in this.connectionMap) {
                var element = this.connectionMap[type]();
                element.from = connection.from;
                element.to = connection.to;
                element.id = connection.id;
                Polymer.dom(self.root).appendChild(element);
            } else {
                console.error("No valid connection found!");
            }
        }
    }];
</script>
