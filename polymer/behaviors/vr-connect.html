<link rel="import" href="../elements/vr-connection-aggregation.html">
<link rel="import" href="../elements/vr-connection-association.html">
<link rel="import" href="../elements/vr-connection-inheritance.html">
<link rel="import" href="vr-three.html">

<script>
    window.VrBehaviors = window.VrBehaviors || {};
    VrBehaviors.ConnectBehavior = [VrBehaviors.ThreeBehavior, {

        observers: ['_handleResizeConnect(width)'],

        attached: function() {
            this.getThreeJS().on('mousedown', this._handleClickConnectButton.bind(this));
            this.ConnectBehavior = {
                fromID: this._getPolymerElement(this.getThreeJS().id).id,
                mesh: null,
                mouseover: this.onMouseOver.bind(this),
                mouseout: this.onMouseOut.bind(this),
                click: this.handleOnClick.bind(this),
                cancel: this.cancel.bind(this),
                connect: this.connect.bind(this),
                allElements: null,
                connectActive: false
            };
        },

        _handleClickConnectButton: function() {
            if(this.highlighted) {
                //create Connect button and eventlistener
                this.ConnectBehavior.mesh = this._initializeConnectButton();
                this._registerConnectListener(this.ConnectBehavior.mesh);
            } else {
                //destroy Connect button and eventlistener
                if(this.ConnectBehavior.connectActive) this._executeCancel();
                this._deregisterConnectListener(this.ConnectBehavior.mesh);
                this._removeConnectButton();
            }
        },

        _handleResizeConnect: function(width) {
            if(!this.highlighted) return;
            this._changeConnectButtonPosition(this.ConnectBehavior.mesh);
        },

        _removeConnectButton: function() {
            this.getThreeJS().remove(this.ConnectBehavior.mesh);
        },

        _changeConnectButtonPosition(mesh) {
            var padding = 10;
            mesh.position.x = this.width / 2 + padding;
            mesh.position.y = -(this.height + padding);
        },

        _registerConnectListener: function(mesh) {
            mesh.on('mouseover', this.ConnectBehavior.mouseover);
            mesh.on('mouseout', this.ConnectBehavior.mouseout);
            mesh.on('mousedown', this.ConnectBehavior.click);
        },

        _deregisterConnectListener: function(mesh) {
            mesh.off('mouseover', this.ConnectBehavior.mouseover);
            mesh.off('mouseout', this.ConnectBehavior.mouseout);
            mesh.off('mousedown', this.ConnectBehavior.click);
        },

        _initializeConnectButton: function() {
            var width = 10;
            var geometry = new THREE.CylinderGeometry(width, width, 10, 32);
            var texture = new THREE.TextureLoader().load( 'images/arrow.png' );
            var material = new THREE.MeshBasicMaterial({color: 0xFFFFFF, map: texture});
            var mesh = new THREE.Mesh(geometry, material);
            mesh.rotateX(90 * (Math.PI/180));
            mesh.rotateY(45 * (Math.PI/180));

            mesh.name = 'connect';
            this._changeConnectButtonPosition(mesh);
            this.getThreeJS().add(mesh);
            return mesh;
        },

        onMouseOver: function(event) {
            event.target.material.color.set(0xFF0000);
        },

        onMouseOut: function(event) {
            event.target.material.color.set(0xFFFFFF);
        },

        handleOnClick: function(event) {
            event.stopPropagation();
            event.origDomEvent.stopImmediatePropagation();
            this.ConnectBehavior.connectActive = true;
            this.ConnectBehavior.allElements = Polymer.dom(this.parentNode).children.slice(0);

            this._deregisterConnectListener(this.ConnectBehavior.mesh);
            this.ConnectBehavior.mesh.on('mousedown', this.ConnectBehavior.cancel);
            event.target.material.color.set(0xFF0000);
            this._registerAllElementsListener();
        },

        connect: function(event) {
            this._executeCancel();
            var fromID = this.ConnectBehavior.fromID;
            var toID = this._getPolymerElement(event.target.id).id;
            Polymer.dom(this.parentNode).appendChild(createNewConnectionNode(toID));

            function createNewConnectionNode(toID) {
                // Dirty workaround to avoid error message from vr-connection
                // that from and to are not defined.
                var wrapper = document.createElement("div");
                wrapper.innerHTML = "<vr-connection-inheritance from=\"#" + fromID
                    + "\" to=\"#" + toID + "\"></vr-connection-inheritance>";
                return wrapper.firstChild;
            }
        },

        cancel: function(event) {
            event.stopPropagation();
            event.origDomEvent.stopImmediatePropagation();
            this._executeCancel();
        },

        _executeCancel: function() {
            this.ConnectBehavior.connectActive = false;
            this.ConnectBehavior.mesh.material.color.set(0xFFFFFF);
            this._deregisterAllElementsListener();
            this.ConnectBehavior.mesh.off('mousedown', this.ConnectBehavior.cancel);
            this._registerConnectListener(this.ConnectBehavior.mesh);
        },

        _registerAllElementsListener: function() {
            var cb = this.ConnectBehavior;
            cb.allElements.forEach(function(element) {
                if(element.id != cb.fromID) { element.getThreeJS().on('mousedown', cb.connect); }
            });
        },

        _deregisterAllElementsListener: function() {
            var cb = this.ConnectBehavior;
            cb.allElements.forEach(function(element) {
                if(element.id != cb.fromID) { element.getThreeJS().off('mousedown', cb.connect); }
            });
        },

        _getPolymerElement: function(id) {
             return Polymer.dom(this.parentNode).children.filter(function(element) {
                return (element.getThreeJS() && element.getThreeJS().id == id);
            })[0];
        }

    }];
</script>
