<link rel="import" href="vr-three.html">
<script src="../js/vr-size-datastruct.js"></script>

<script>
    window.VrBehavior = window.VrBehavior || {};
    VrBehavior.InnerSizing = [VrBehavior.ThreeJS, {
        observers: ['_sizingHandler(width, height)'],

        ready: function() {
            this.sizeInformations = {
                "0": VrSizeDatastruct({height: 25}, {height: 25}, {height: 0.2, width:1}),
                "1": VrSizeDatastruct(null, null, {height: 0.4, width:1}),
                "2": VrSizeDatastruct(null, null, {height: 0.4, width:1})
            };

            // first setup
            this.boxItems = this._sizeInnerElements(this.width, this.height);
        },

        _sizingHandler: function(width, height) {
            if(this.boxItems) {
                var properties = this._sizeInnerElements(width, height);
                this.splice('boxItems', 0, 3, properties[0], properties[1], properties[2]);
            }
        },

        _sizeInnerElements: function(width, height) {
            var texts = [this.text1, this.text2, this.text3];
            var y = 0;

            var size = (calculateSize.bind(this))([], width, height, 1, Object.keys(this.sizeInformations));
            var y = 0;
            var properties = size.map(function(size, i){
                var position = {x: 0, y: y};
                y -= size.height;
                return createProperties(position, size, texts[i])
            });

            return properties;

            function calculateSize(arr, width, height, percentage, posibilities) {
                var tmpHeight = tmpPercentage = 0;
                var tmpPosibilities = [];

                for(var key in this.sizeInformations) {
                    if(posibilities.indexOf(String(key)) == -1) { continue; }
                    var tmp = this.sizeInformations[key](width, proportion(1), height, proportion(percentage));
                    tmpHeight += tmp.diffHeight;
                    tmpPercentage += tmp.percentageHeight;
                    arr = append(arr, key, tmp.size);
                    if(tmp.percentageHeight != 0) { tmpPosibilities.push(key); }
                }

                if(tmpHeight == 0) { return arr; }
                return (calculateSize.bind(this))(arr, width, height + tmpHeight, tmpPercentage, tmpPosibilities);

                function append(arr, index, value) {
                    index = parseInt(index, 10);
                    if(arr[index] === undefined) {
                        arr.push(value)
                    } else {
                        arr[index] = value;
                    }
                    return arr;
                }
            }

            function proportion(percentage) {
                return 1 / percentage;
            }

            function createProperties(position, size, text) {
                return {
                    x: position.x,
                    y: position.y - (size.height/2), // (size.height/2) to set y in center
                    width: size.width,
                    height: size.height,
                    depth: size.depth || 10,
                    text: text,
                    textCenter: true
                }
            }
        }
    }];
</script>
