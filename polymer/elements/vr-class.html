<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="vr-class">
    <template>
        <template is="dom-repeat" items="{{boxItems}}">
            <vr-box x-pos="{{item.x}}" y-pos="{{item.y}}" width="{{item.width}}"
                    height="{{item.height}}" depth="{{item.depth}}"
                    text="{{item.text}}" text-center="{{item.textCenter}}"></vr-box>
        </template>
    </template>
</dom-module>

<script>
    Polymer({
        is: "vr-class",

        properties: {
            xPos: {
                type: Number,
                value: 0
            },
            yPos: {
                type: Number,
                value: 0
            },
            width: {
                type: Number,
                value: 50
            },
            height: {
                type: Number,
                value: 50
            },
            depth: {
                type: Number,
                value: 10
            },
            text1: {
                type: String,
                value: ''
            },
            text2: {
                type: String,
                value: ''
            },
            text3: {
                type: String,
                value: ''
            }
        },

        observers: [
            'updateClass(xPos, yPos, width, height, depth, text1, text2, text3)'
        ],

        updateClass: function (xPos, yPos, width, height, depth, text1, text2, text3) {
            if (this.obj) {
                var properties = this._getBoxItemProperties(width, height, depth, text1, text2, text3);
                this.splice('boxItems', 0, 3, properties[0], properties[1], properties[2]);
            }
        },

        ready: function () {
            this.obj = new THREE.Group();
            this.obj.position.setX(this.xPos);
            this.obj.position.setY(this.yPos);

            this.boxItems = this._getBoxItemProperties(this.width, this.height, this.depth, this.text1, this.text2, this.text3);
        },

        attached: function () {
            this._getChildren().forEach(function (box) {
                this.obj.add(box.obj);
            }.bind(this));
        },

        _getChildren: function () {
            // return all children except template element
            return Polymer.dom(this.root).children.filter(function (node) {
                return node.localName != 'template';
            });
        },

        _getBoxItemProperties: function (width, height, depth, text1, text2, text3) {
            /* Hopefully not so Magic Calculation */
            // fix default value for first box
            var firstBoxHeight = 10;
            // calculate the heights for the 2 remaining boxes
            var elementHeight = (height - firstBoxHeight) / 2;

            // calculate y positions
            var yValueElement1 = -(firstBoxHeight / 2);
            var yValueElement2 = -(firstBoxHeight + elementHeight / 2);
            var yValueElement3 = (yValueElement2 - elementHeight);

            var properties = [
                {
                    x: 0,
                    y: yValueElement1,
                    width: width,
                    height: firstBoxHeight,
                    depth: depth,
                    text: text1,
                    textCenter: true
                },
                {
                    x: 0,
                    y: yValueElement2,
                    width: width,
                    height: elementHeight,
                    depth: depth,
                    text: text2,
                    textCenter: false
                },
                {
                    x: 0,
                    y: yValueElement3,
                    width: width,
                    height: elementHeight,
                    depth: depth,
                    text: text3,
                    textCenter: false
                }];

            return properties;
        },

        // simple on click
        onClick: function () {
            var self = this;

            this._getChildren().forEach(function (box) {
                box.onClick();
            }.bind(this));

            if (!this.gui) {
                var Menu = function () {
                    this.name = self.text1;
                    this.variables = self.text2;
                    this.functions = self.text3;
                    this.width = self.width;
                    this.height = self.height;
                };
                var text = new Menu();
                this.gui = new dat.GUI();
                var text1Controller = this.gui.add(text, 'name');
                var text2Controller = this.gui.add(text, 'variables');
                var text3Controller = this.gui.add(text, 'functions');
                var widthController = this.gui.add(text, 'width', 30, 70);
                var heightController = this.gui.add(text, 'height', 60, 200);

                text1Controller.onFinishChange(function (text) {
                    self.text1 = text;
                });
                text2Controller.onFinishChange(function (text) {
                    self.text2 = text;
                });
                text3Controller.onFinishChange(function (text) {
                    self.text3 = text;
                });
                widthController.onFinishChange(function (width) {
                    self.width = width;
                    self.fire('vr-resize', {});
                });
                heightController.onFinishChange(function (height) {
                    self.height = height;
                    self.fire('vr-resize', {});
                })
            } else {
                this.gui.destroy();
                this.gui = null;
            }
        }

    });
</script>
