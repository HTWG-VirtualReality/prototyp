<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="./vr-polygon.html">
<link rel="import" href="./vr-polyline.html">



<dom-module id="vr-connection-extends">
    <template>
        <vr-polygon id="polygon"></vr-polygon>
        <vr-polyline id="polyline"></vr-polyline>
    </template>
</dom-module>

<script>
    Polymer({
        is: "vr-connection-extends",

        properties: {
            from: String,
            to: String
        },

        ready: function () {
            if (!this.from || !this.to) {
                console.error('properties from and to must be set');
                return;
            }

            var fromObj = document.querySelector(this.from);
            var toObj = document.querySelector(this.to);
            if (!fromObj || !toObj) {
                console.error('could not find element');
                return;
            }

            var fromY = fromObj.obj.position.y;
            var toY = toObj.obj.position.y;

            // create group and set position
            this.obj = new THREE.Group();
            this.obj.position.setX((toY < fromY) ? fromObj.obj.position.x : toObj.obj.position.x);
            this.obj.position.setY((toY < fromY) ? fromY - fromObj.height : toY - toObj.height);
            this._createArrowHead(fromObj, toObj);

            // create and add <vr-point> to polyline
            this._createLinePointTop(fromObj, toObj);
            this._createLinePointBottom(fromObj, toObj);

            // add event listener for resizing
            fromObj.addEventListener('vr-resize', this._resizeConnection.bind(this));
            toObj.addEventListener('vr-resize', this._resizeConnection.bind(this));

            Polymer.dom(this.root).children.forEach(function (box) {
                this.obj.add(box.obj);
            }.bind(this));
        },

        _createLinePointTop: function (fromObj, toObj) {
            var point = document.createElement('vr-point');
            point.x = 0;
            point.y = fromObj.obj.position.y < toObj.obj.position.y ? 0 : -10;
            Polymer.dom(this.$.polyline).appendChild(point);
        },

        _createLinePointBottom: function (fromObj, toObj) {
            this.vrPointBottom = document.createElement('vr-point');
            var fromPos = fromObj.obj.position;
            var toPos = toObj.obj.position;

            this.vrPointBottom.x =  this._getDifferenceX(fromObj, toObj) * ((fromPos.x < toPos.x) ? 1 : -1);
            //TODO: improve calculation
            this.vrPointBottom.y = this._getDifferenceY(fromObj, toObj);
            Polymer.dom(this.$.polyline).appendChild(this.vrPointBottom);
        },

        _resizeConnection: function () {
            var fromObj = document.querySelector(this.from);
            var toObj = document.querySelector(this.to);

            // set new start point
            this.obj.position.setY(fromObj.obj.position.y - fromObj.height);
            // remove old bottom point
            Polymer.dom(this.$.polyline).removeChild(this.vrPointBottom);
            // create and add new bottom point
            this._createLinePointBottom(fromObj, toObj);
        },

        _createArrowHead: function (fromObj, toObj) {
            var fromY = fromObj.obj.position.y;
            var toY = toObj.obj.position.y;

            this._createPolygonPoint(0, (fromY > toY) ? 0 : this._getDifferenceY(fromObj, toObj) - 10);
            this._createPolygonPoint(-10, (fromY > toY) ? -10 : this._getDifferenceY(fromObj, toObj));
            this._createPolygonPoint(10, (fromY > toY) ? -10 : this._getDifferenceY(fromObj, toObj));
        },

        _createPolygonPoint: function (x, y) {
            var point = document.createElement('vr-point');
            point.x = x;
            point.y = y;
            Polymer.dom(this.$.polygon).appendChild(point);
        },

        _getDifferenceY: function(fromObj, toObj) {
            var difference = Math.abs(fromObj.obj.position.y - toObj.obj.position.y);
            difference -= (fromObj.height/2 + toObj.height/2);
            difference -= (fromObj.obj.position.y > toObj.obj.position.y ? 0 : 10)
            return difference * -1;
        },

        _getDifferenceX: function(fromObj, toObj) {
            return Math.abs(fromObj.obj.position.x - toObj.obj.position.x)
        }


    });
</script>
