<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="./vr-polygon.html">
<link rel="import" href="./vr-polyline.html">



<dom-module id="vr-connection-extends">
    <template>
        <vr-polygon id="polygon"></vr-polygon>
        <vr-polyline id="polyline"></vr-polyline>
    </template>
</dom-module>

<script>
    Polymer({
        is: "vr-connection-extends",

        properties: {
            from: String,
            to: String
        },

        ready: function () {
            if (!this.from || !this.to) {
                console.error('properties from and to must be set');
                return;
            }

            var fromObj = document.querySelector(this.from);
            var toObj = document.querySelector(this.to);
            if (!fromObj || !toObj) {
                console.error('could not find element');
                return;
            }

            // create group
            this.obj = new THREE.Group();

            var fromPos = fromObj.obj.position;
            var toPos = toObj.obj.position;

            this.obj.position.setX((toPos.x < fromPos.x) ? toPos.x : fromPos.x);
            this.obj.position.setY((toPos.x < fromPos.x) ? toPos.y - toObj.height/2 : fromPos.y - fromObj.height/2);

            if(fromPos.x == toPos.x) {
                // vertical
                var y = absoluteSubtraction(fromPos.y, toPos.y);
                this._createLinePoint(0, toIsGreater() ? -(fromObj.height/2) : 0 + fromObj.height/2);
                this._createLinePoint(0, toIsGreater() ? -(y-toObj.height/2) : y - toObj.height/2);

                // polygon points
                var height1 = toIsGreater() ? -(fromObj.height/2) : (fromObj.height/2);
                var height2 = toIsGreater() ? height1 - 10 : height1 + 10;
                this._createPolygonPoint(0, height1);
                this._createPolygonPoint(10, height2);
                this._createPolygonPoint(-10, height2);
            } else if (fromPos.y == toPos.y) {
                // horizontal
                var widthLeft = (toPos.x > fromPos.x) ? fromObj.width/2 : toObj.width/2;
                var widthRight = (toPos.x < fromPos.x) ? fromObj.width/2 : toObj.width/2;
                this._createLinePoint(widthLeft, 0);
                this._createLinePoint(absoluteSubtraction(fromPos.x, toPos.x) - widthRight, 0);

                // polygon points
                var width1 = (toPos.x > fromPos.x) ? fromObj.width/2 : absoluteSubtraction(fromPos.x, toPos.x) - fromObj.width/2;
                var width2 = (toPos.x > fromPos.x) ? width1 + 10 : width1 - 10;
                this._createPolygonPoint(width1, 0);
                this._createPolygonPoint(width2, 10);
                this._createPolygonPoint(width2, -10);
            } else {
                // diagonal
                var a = absoluteSubtraction(fromPos.x, toPos.x);
                var tmp = absoluteSubtraction(fromObj.height/2, toObj.height/2);
                tmp = absoluteSubtraction(toPos.y, tmp);
                var b = absoluteSubtraction(fromPos.y, tmp);

                var alpha = Math.atan((a / b))
                var h1 = (fromPos.x < toPos.x) ? toObj.height/2 : fromObj.height/2;
                var h2 = Math.tan(alpha) * h1;
                var x2 = absoluteSubtraction(a, h2);
                var y2 = absoluteSubtraction(b, h1);

                h1 = (fromPos.x < toPos.x) ? fromObj.height/2 : toObj.height/2;
                h2 = Math.tan(alpha) * h1;
                var x1 = h2;
                var y1 = h1;

                this._createLinePoint(x1, toIsGreater() ? y1 : -y1);
                this._createLinePoint(x2, toIsGreater() ? y2 : -y2);

                if(toPos.x < fromPos.x) {
                    this._createPolygonPoint(x2, toIsGreater() ? y2 : -y2)
                    this._createPolygonPoint(x2 - 10, (y2 - 10) * (toIsGreater() ? 1 : -1))
                    this._createPolygonPoint(x2 + 10, (y2 - 10) * (toIsGreater() ? 1 : -1))
                } else {
                    this._createPolygonPoint(x1, toIsGreater() ? y1 : -y1)
                    this._createPolygonPoint(x1 - 10, (y1 + 10) * (toIsGreater() ? 1 : -1))
                    this._createPolygonPoint(x1 + 10, (y1 + 10) * (toIsGreater() ? 1 : -1))
                }
            }

            // add event listener for resizing
            fromObj.addEventListener('vr-resize', this._resizeConnection.bind(this));
            toObj.addEventListener('vr-resize', this._resizeConnection.bind(this));

            Polymer.dom(this.root).children.forEach(function (box) {
                this.obj.add(box.obj);
            }.bind(this));

            function absoluteSubtraction(num1, num2) {
                return Math.abs(Math.abs(num1) - Math.abs(num2));
            }

            function toIsGreater() {
                return (toPos.x > fromPos.x) ? toPos.y > fromPos.y : toPos.y < fromPos.y;
            }
        },

        _createLinePoint: function(x, y) {
            var point = document.createElement('vr-point');
            point.x = x;
            point.y = y;
            Polymer.dom(this.$.polyline).appendChild(point);
        },

        _createPolygonPoint: function(x, y) {
            var point = document.createElement('vr-point');
            point.x = x;
            point.y = y;
            Polymer.dom(this.$.polygon).appendChild(point);
        },

        _resizeConnection: function () {
            console.log('resize');
        }


    });
</script>
