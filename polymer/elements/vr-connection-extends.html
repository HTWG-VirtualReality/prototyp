<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="vr-connection-extends">
    <template>
        <vr-polygon>
            <vr-point x="0" y="0"></vr-point>
            <vr-point x="-10" y="-10"></vr-point>
            <vr-point x="10" y="-10"></vr-point>
        </vr-polygon>
        <vr-polyline id="polyline">
            <template is="dom-repeat" items="{{linePoints}}">
                <vr-point x="{{item.x}}" y="{{item.y}}"></vr-point>
            </template>
        </vr-polyline>
    </template>
</dom-module>

<script>
    Polymer({
        is: "vr-connection-extends",

        properties: {
            from: String,
			to: String
        },

        ready: function() {
            if(!this.from || !this.to) {
                console.error('properties from and to must me set');
                return;
            }

            var fromObj = document.querySelector(this.from);
            var toObj = document.querySelector(this.to);
            if (!fromObj || !toObj) {
                console.error('could not find element');
                return;
            }

            this.obj = new THREE.Group();
            this._createConnection();

            // Add Eventlistener
            fromObj.addEventListener('vr-resize', this._resizeConnection.bind(this));
        },

        attached: function () {
            this._getChildren().forEach(function (box) {
                this.obj.add(box.obj);
            }.bind(this));
        },

        _getChildren: function () {
            // return all children except template element
            return Polymer.dom(this.root).children.filter(function (node) {
                return node.localName != 'template';
            });
        },

        _createConnection: function() {
            // Get objects
            var fromObj = document.querySelector(this.from);
            var toObj = document.querySelector(this.to);

            // Get bounding box
            var size = fromObj.height;

            // set position for group
            this.obj.position.setX(fromObj.obj.position.x);
            this.obj.position.setY(fromObj.obj.position.y - size);

            // create and add <vr-point> to polyline
            this.linePoints = this._createPoints();
        },

        _createPoints: function() {
            // Get objects
            var fromObj = document.querySelector(this.from);
            var toObj = document.querySelector(this.to);

            // create points array
            var result = [];
            result.push({x:0, y:-10})
            result.push({x:0, y:(fromObj.obj.position.y - toObj.obj.position.y - fromObj.height) * -1})
            return result;
        },

        _resizeConnection: function(e) {
            var element = e.srcElement;
            // set new start point
            this.obj.position.setY(element.obj.position.y - element.height);

            // calculate new points
            var toObj = document.querySelector(this.to);
            var points = this._createPoints()
            points[1].y = (element.obj.position.y - toObj.obj.position.y - element.height) * -1;
            this.splice('linePoints', 0, 2, points[0], points[1]);
            this.querySelector('#polyline').updateLine()
        }
    });
</script>
