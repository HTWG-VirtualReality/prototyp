<script src="../bower_components/threejs/build/three.min.js"></script>
<script src="../bower_components/threex.domevents/threex.domevents.js"></script>

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../behaviors/vr-zoom.html">
<link rel="import" href="../behaviors/vr-axis-control.html">
<link rel="import" href="../behaviors/vr-new.html">
<link rel="import" href="../behaviors/vr-touch.html">
<link rel="import" href="../behaviors/vr-webvr.html">
<link rel="import" href="./vr-class.html">


<dom-module id="vr-scene">
    <template>
        <style>
            button {
                position: fixed;
                top: 0;
                left: 0;
                padding: 10px;
                z-index: 1;
                background: white;
            }
        </style>

        <button on-click="_enterVR">Enter VR (WebVR/Mobile only)</button>

        <content id="content" select="*"></content>

        <div id="classItems">
            <template is="dom-repeat" items="{{classItems}}" strip-whitespace>
                <vr-class id="{{item.id}}" x-pos="{{item.xPos}}" y-pos="{{item.yPos}}" class-type="{{item.classType}}"></vr-class>
            </template>
        </div>

    </template>
</dom-module>

<script>
    Polymer({
        is: "vr-scene",

        behaviors: [
            VrBehaviors.TouchBehavoir,
            VrBehaviors.ZoomBehavior,
            VrBehaviors.AxisControlBehavior,
            VrBehaviors.NewBehavior,
            VrBehaviors.WebvrBehavior
        ],

        properties: {
            classItems: {
                type: Array,
                value: function() {
                    return [];
                }
            }
        },

        created: function() {
            var self = this;
            self.renderer = self._createRenderer();
            self.camera = self._createCamera();
            self.scene = new THREE.Scene();
            self._initiateThreeEvents();
            self.group = self._createGroup();
            self.scene.add(self.camera);
            self.scene.add(self.group);
        },

        _initiateThreeEvents: function() {
            var self = this;
            var domEvents = new THREEx.DomEvents(self.camera, self.renderer.domElement);
            THREE.Object3D.prototype.on = function(eventName, callback, useCapture) {
                domEvents.bind(this, eventName, callback, useCapture || false);
            };
            THREE.Object3D.prototype.off = function(eventName, callback, useCapture) {
                domEvents.unbind(this, eventName, callback, useCapture || false);
            };
        },

        ready: function () {
            var self = this;
            Polymer.dom(self.root).appendChild(self.renderer.domElement);

            // observe nodes that will added to this element
            Polymer.dom(self.$.content).observeNodes(observe);
            Polymer.dom(self.$.classItems).observeNodes(observe);

            function observe(nodes) {
                nodes.addedNodes.forEach(function (node) {
                    if (node.obj) {
                        self.group.add(node.obj);
                    }
                });

                nodes.removedNodes.forEach(function (node) {
                    if (node.obj) {
                        self.group.remove(node.obj);
                    }
                });
            }

            self._render();
        },

        _createRenderer: function () {
            var renderer = new THREE.WebGLRenderer({antialias: true});
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setClearColor(0xf0f0f0);
            return renderer;
        },

        _createCamera: function () {
            var camera = new THREE.PerspectiveCamera(90, window.innerWidth / window.innerHeight, 1, 1000);
            camera.add(new THREE.PointLight(0xffffff));
            return camera;
        },

        _createGroup: function () {
            var group = new THREE.Group();
            group.position.setZ(-300);
            return group;
        },

        _render: function () {
            requestAnimationFrame(this._render.bind(this));
            this.controls.update(); //WebvrBehavior
            this.effect.render(this.scene, this.camera);
        }

    });
</script>
