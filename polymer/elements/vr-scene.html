<link rel="import" href="../bower_components/polymer/polymer.html">

<script src="../bower_components/threejs/build/three.min.js"></script>
<script src="../bower_components/threex.domevents/threex.domevents.js"></script>

<dom-module id="vr-scene">
    <template>
        <content id="content" select="*"></content>
    </template>
</dom-module>

<script>
    Polymer({
        is: "vr-scene",

        controls: {
            positionX: 0,
            positionY: 0,
            mouseX: 0,
            mouseY: 0,
            speed: 0.5
        },

        ready: function() {
            function renderer() {
                var renderer = new THREE.WebGLRenderer({antialias: true});
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.setClearColor(0xf0f0f0);
                return renderer;
            }
            function camera() {
                var camera = new THREE.PerspectiveCamera(90, window.innerWidth / window.innerHeight, 1, 1000);
                camera.add(new THREE.PointLight(0xffffff));
                camera.position.setZ(200);
                return camera;
            }

            var self = this;
            self.renderer = renderer();
            self.camera = camera();
            self.scene = new THREE.Scene();
            self.group = new THREE.Group();
            self.scene.add(self.camera);
            self.scene.add(self.group);
            Polymer.dom(self.root).appendChild(self.renderer.domElement);

            // domEvents to listen for dom events inside our 3d scene
            var domEvents = new THREEx.DomEvents(this.camera, this.renderer.domElement);

            // observe nodes that will added to this element
            Polymer.dom(self.$.content).observeNodes(function(nodes) {
                nodes.addedNodes.forEach(function(node) {
                    self.group.add(node.obj);

                    // register click listener
                    domEvents.addEventListener(node.obj, 'click', function() {
                        if (node.onClick) {
                            node.onClick();
                        }
                    }, false);
                });

                nodes.removedNodes.forEach(function(node) {
                    self.group.remove(node.obj);
                });
            });

            // start rendering
            self._render();

            document.addEventListener('mousedown', onMouseDown, false);
            function onMouseDown(event) {
                event.preventDefault();

                document.addEventListener('mousemove', onMouseMove, false );
                document.addEventListener('mouseup', resetMouse, false );
                document.addEventListener('mouseout', resetMouse, false );

                self.controls.positionX = self.group.position.x;
                self.controls.positionY = self.group.position.y;
                self.controls.mouseX = event.clientX;
                self.controls.mouseY = event.clientY;
            }
            function onMouseMove(event) {
                var moveX = event.clientX - self.controls.mouseX;
                var moveY = self.controls.mouseY - event.clientY;

                self.group.position.x = self.controls.positionX + moveX * self.controls.speed;
                self.group.position.y = self.controls.positionY + moveY * self.controls.speed;
            }
            function resetMouse() {
                document.removeEventListener('mousemove', onMouseMove, false );
                document.removeEventListener('mouseup', resetMouse, false );
                document.removeEventListener('mouseout', resetMouse, false );
            }
        },

        _render: function() {
            requestAnimationFrame(this._render.bind(this));
            this.renderer.render(this.scene, this.camera);
        }

    });
</script>