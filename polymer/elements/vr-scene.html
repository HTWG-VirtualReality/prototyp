<link rel="stylesheet" href="../style/stylesheet.css">

<script src="../bower_components/threejs/build/three.min.js"></script>
<script src="../bower_components/threex.domevents/threex.domevents.js"></script>

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../behaviors/vr-zoom.html">
<link rel="import" href="../behaviors/vr-axis-control.html">

<link rel="import" href="../behaviors/vr-new-class.html">
<link rel="import" href="../behaviors/vr-touch.html">
<link rel="import" href="../behaviors/vr-webvr.html">
<link rel="import" href="../behaviors/vr-scene.html">
<link rel="import" href="./vr-class.html">
<link rel="import" href="./vr-connection-inheritance.html">
<link rel="import" href="./vr-connection-aggregation.html">
<link rel="import" href="./vr-connection-association.html">


<dom-module id="vr-scene">
    <template>
        <button class="top-left" on-click="_enterVR">Enter VR (WebVR/Mobile only)</button>
        <button class="top-left save" on-click="_save">Save</button>
        <button class="bottom-right" on-click="_resetPose">Reset Pose</button>

        <content id="content" select="*"></content>

        <div id="itemsContent">
            <template is="dom-repeat" items="{{classItems}}" strip-whitespace>
                <vr-class id="{{item.id}}" x-pos="{{item.xPos}}" y-pos="{{item.yPos}}"
                          class-type="{{item.classType}}"></vr-class>
            </template>

            <!-- For connections -->
            <template is="dom-repeat" items="{{connectionInheritanceItems}}" strip-whitespace>
                <vr-connection-inheritance from="{{item.from}}" to="{{item.to}}"></vr-connection-inheritance>
            </template>
            <template is="dom-repeat" items="{{connectionAssociationItems}}" strip-whitespace>
                <vr-connection-association from="{{item.from}}" to="{{item.to}}"></vr-connection-association>
            </template>
            <template is="dom-repeat" items="{{connectionAggregationItems}}" strip-whitespace>
                <vr-connection-aggregation from="{{item.from}}" to="{{item.to}}"></vr-connection-aggregation>
            </template>
        </div>
    </template>
</dom-module>

<script>
    window.VrElement = window.VrElement || {};
    VrElement.Scene = Polymer({
        is: "vr-scene",

        behaviors: [
            VrBehavior.Touch,
            VrBehavior.Zoom,
            VrBehavior.AxisControl,
            VrBehavior.NewClass,
            VrBehavior.Webvr,
            VrBehavior.Scene
        ],

        properties: {
            classItems: {
                type: Array,
                value: function () { return []; }
            },
            connectionInheritanceItems: {
                type: Array,
                value: function () { return [] }
            },
            connectionAssociationItems: {
                type: Array,
                value: function () { return [] }
            },
            connectionAggregationItems: {
                type: Array,
                value: function () { return [] }
            }
        },

        ready: function () {
            var self = this;
            Polymer.dom(self.root).appendChild(self.renderer.domElement);

            // observe nodes that will added to this element
            Polymer.dom(self.$.content).observeNodes(observe);
            Polymer.dom(self.$.itemsContent).observeNodes(observe);

            function observe(nodes) {
                nodes.addedNodes.forEach(function (node) {
                    if (node.getThreeJS) {
                        self.group.add(node.getThreeJS());
                    }
                });

                nodes.removedNodes.forEach(function (node) {
                    if (node.getThreeJS) {
                        self.group.remove(node.getThreeJS());
                    }
                });
            }

            self._render();
        },

        deleteShape: function(obj) {
          var items = this._getItemsArray(obj)
          this[items] = this[items].filter(function(e){ return e.id != obj.id; })
        },

        _getItemsArray: function(obj) {
          if(obj instanceof VrElement.Class) { return "classItems" }
        }

    });
</script>
