<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="./vr-polygon.html">
<link rel="import" href="./vr-polyline.html">

<script src="../js/general-connection.js"></script>

<dom-module id="vr-connection-association">
    <template>
        <vr-polyline id="start"></vr-polyline>
        <vr-polyline id="line"></vr-polyline>
    </template>
</dom-module>

<script>
    Polymer({
        is: "vr-connection-association",

        properties: {
            from: String,
            to: String
        },

        ready: function () {
            if (!this.from || !this.to) {
                console.error('properties from and to must be set');
                return;
            }

            var fromObj = document.querySelector(this.from);
            var toObj = document.querySelector(this.to);
            if (!fromObj || !toObj) {
                console.error('could not find element');
                return;
            }

            // create group
            this.obj = new THREE.Group();

            // calculate and render connection
            this._render();

            // add event listener for resizing
            this._registerAllListener(fromObj, toObj);

            // add Polymer children to three js group
            Polymer.dom(this.root).children.forEach(function (box) {
                this.obj.add(box.obj);
            }.bind(this));
        },

        _render: function() {
            var fromObj = document.querySelector(this.from);
            var toObj = document.querySelector(this.to);

            var gc = new GeneralConnection(fromObj, toObj);
            var points = gc.render();

            // set startpoint
            this.obj.position.setX(points.start.x);
            this.obj.position.setY(points.start.y);

            // create line
            this._createLinePoint(points.l1.x, points.l1.y);
            this._createLinePoint(points.l2.x, points.l2.y);

            // create start placing
            this._createStartPlacingPoint(10, (points.py + (10 * points.ps)) * points.pd);
            this._createStartPlacingPoint(0, points.py * points.pd);
            this._createStartPlacingPoint(-10, (points.py + (10 * points.ps)) * points.pd);

            // rotate line and start placing
            this.$.line.obj.rotation.z = points.angle || 0;
            this.$.start.obj.rotation.z = points.angle || 0;
        },

        _registerAllListener: function(fromObj, toObj) {
            this._registerListener(fromObj, toObj, 'vr-resize', this._resizeConnection);
            this._registerListener(fromObj, toObj, 'vr-delete', this._deleteConnection);
        },

        _registerListener: function(fromObj, toObj, event, func) {
            fromObj.addEventListener(event, func.bind(this));
            toObj.addEventListener(event, func.bind(this));
        },

        _createLinePoint: function(x, y) {
            this._createPoint(x, y, this.$.line);
        },

        _createStartPlacingPoint: function(x, y) {
            this._createPoint(x, y, this.$.start);
        },

        _createPoint: function(x, y, element) {
            var point = document.createElement('vr-point');
            point.x = x;
            point.y = y;
            Polymer.dom(element).appendChild(point);
        },

        _resizeConnection: function () {
            // remove all children from polyline and polygon
            removeAllChildren(this.$.start);
            removeAllChildren(this.$.line);
            this._render();

            function removeAllChildren(parent) {

                var dom = Polymer.dom(parent);
                dom.children.forEach(function (child) {
                    dom.removeChild(child);
                });
            }
        },

        _deleteConnection: function() {
            console.log('delete');
            Polymer.dom(this).parentNode.removeChild(this);
        }

    });
</script>
