<link rel="import" href="../bower_components/polymer/polymer.html">
<script src="../bower_components/threex.dynamictexture/threex.dynamictexture.js"></script>
<script src="../bower_components/dat.gui/dat.gui.js"></script>

<script>
    Polymer({
        is: "vr-box",

        properties: {
            xPos: {
                type: Number,
                value: 0
            },
            yPos: {
                type: Number,
                value: 0
            },
            width: {
                type: Number,
                value: 50
            },
            height: {
                type: Number,
                value: 50
            },
            depth: {
                type: Number,
                value: 50
            },
            text: {
                type: String,
                value: ''
            }
        },

        observers: [
            'updateBox(xPos, yPos, width, height, depth, text)'
        ],

        updateBox: function (xPos, yPos, width, height, depth, text) {
            if (this.obj) {
                this.obj.remove(this.cube);
                this.obj.remove(this.wireframe);

                this._createBox(width, height, depth, text);
                this.wireframe.material.color.set(0xff0000);

                this.obj.add(this.cube);
                this.obj.add(this.wireframe);
            }
        },

        ready: function () {
            var sides = 6;
            this.materials = [];

            // init all sides of cube
            for (var i = 0; i < sides; i++) {
                this.materials.push(new THREE.MeshBasicMaterial({
                    color: 0xffffff
                }));
            }

            // creating cube and wireframe
            this._createBox(this.width, this.height, this.depth, this.text);

            this.obj = new THREE.Group();
            this.obj.position.setX(this.xPos);
            this.obj.position.setY(this.yPos);
            this.obj.add(this.cube);
            this.obj.add(this.wireframe);
        },

        onClick: function () {
            var self = this;

            // TODO: auslagern in neues polymer element
            if (!this.gui) {
                var FizzyText = function () {
                    this.message = self.text;
                    this.width = self.width;
                    this.height = self.height;
                };
                var text = new FizzyText();
                this.gui = new dat.GUI();
                var textController = this.gui.add(text, 'message');
                var widthController = this.gui.add(text, 'width', 30, 70);
                var heightController = this.gui.add(text, 'height', 30, 70);
                widthController.onFinishChange(function (width) {
                    self.width = width;
                });
                textController.onFinishChange(function (text) {
                    self.text = text;
                });
                heightController.onFinishChange(function (height) {
                    self.height = height;
                })
            }

            if (this.wireframe.material.color.r == 0) {
                this.wireframe.material.color.set(0xff0000);
            } else {
                this.wireframe.material.color.set(0x000000);
                this.gui.destroy();
                this.gui = null;
            }
        },

        _createBox: function (width, height, depth, text) {
            // sides of the box
            var left = 0, right = 1, bottom = 2, top = 3, front = 4, back = 5;

            // create text
            var dynamicTexture = new THREEx.DynamicTexture(512, 512);
            dynamicTexture.context.font = "bolder 64px Verdana";
            dynamicTexture.clear('white').drawText(text, 20, 100, 'black');
            this.materials[front].map = dynamicTexture.texture;

            // create box and wireframe
            var geometry = new THREE.BoxGeometry(parseInt(width), parseInt(height), parseInt(depth));
            this.cube = new THREE.Mesh(geometry, new THREE.MeshFaceMaterial(this.materials));
            this.wireframe = new THREE.BoxHelper(this.cube);
            this.wireframe.material.color.set(0x000000);
        }

    });
</script>