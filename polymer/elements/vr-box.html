<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../behaviors/vr-positioner.html">
<link rel="import" href="../behaviors/vr-size.html">

<script src="../bower_components/dat.gui/dat.gui.js"></script>
<script src="../js/threex.dynamic-texture.js"></script>

<script>
    window.VrElement = window.VrElement || {};
    VrElement.Box = Polymer({
        is: "vr-box",

        properties: {
            text: {
                type: String,
                value: ''
            },
            textCenter: {
                type: Boolean,
                value: false
            },
            image: {
                type: String,
                value: 'none',
                observer: '_boxImage'
            }
        },

        behaviors: [
            VrBehavior.Positioner,
            VrBehavior.Size,
        ],

        observers: [
            'updateBox(xPos, yPos, width, height, depth, text, image)'
        ],

        _boxImage: function (newValue) {
            var validTypes = ['create', 'delete', 'move', 'edit'];
            if (validTypes.indexOf(newValue) === -1) {
                // set default value
                this.classType = 'none';
            }
        },

        updateBox: function (xPos, yPos, width, height, depth, text, image) {
            if (this.getThreeJS().children.length > 0) {
                this.getThreeJS().remove(this.cube);
                this.getThreeJS().remove(this.wireframe);

                this._createBox(width, height, depth, text, image);
                this.wireframe.material.color.set(0xff0000);

                this.getThreeJS().add(this.cube);
                this.getThreeJS().add(this.wireframe);
            }
        },

        ready: function () {
            var sides = 6;
            this.materials = [];

            // init all sides of cube
            var material = new THREE.MeshBasicMaterial({color: 0xffffff});
            for (var i = 0; i < sides; i++) {
                this.materials.push(material);
            }

            // creating cube and wireframe
            this._createBox(this.width, this.height, this.depth, this.text, this.image);
            this.getThreeJS().add(this.cube);
            this.getThreeJS().add(this.wireframe);
        },

        _createBox: function (width, height, depth, text, image) {
            // sides of the box
            var left = 0, right = 1, bottom = 2, top = 3, front = 4, back = 5;

            // create text
            var dynamicTexture = new THREEx.DynamicTexture(width * 10, height * 10);
            dynamicTexture.texture.minFilter = THREE.NearestFilter;
            dynamicTexture.clear('white').drawTextCooked({
                text: text,
                font: "64px Verdana",
                center: this.textCenter
            });


            var frontSideElement;

            if(image === 'create') {
                frontSideElement = new THREE.TextureLoader().load( 'images/create.png' );
            } else if(image === 'delete') {
                frontSideElement = new THREE.TextureLoader().load( 'images/delete.png' );
            } else if(image === 'edit') {
                frontSideElement = new THREE.TextureLoader().load( 'images/edit.png' );
            } else if(image === 'move') {
                frontSideElement = new THREE.TextureLoader().load( 'images/move.png' );
            } else {
                frontSideElement = dynamicTexture.texture
            }

            this.materials[front] =  new THREE.MeshBasicMaterial({
                map: frontSideElement
            });

            // create box and wireframe
            var geometry = new THREE.BoxGeometry(parseInt(width), parseInt(height), parseInt(depth));
            this.cube = new THREE.Mesh(geometry, new THREE.MeshFaceMaterial(this.materials));
            this.wireframe = new THREE.BoxHelper(this.cube);
            this.wireframe.material.color.set(0x000000);
        },

        highlight: function () {
            if (this.wireframe.material.color.r == 0) {
                this.wireframe.material.color.set(0xff0000);
            } else {
                this.wireframe.material.color.set(0x000000);
            }
        }

    });
</script>